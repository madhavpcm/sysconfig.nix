# sysconfig.nix

Heavily inspired from https://unmovedcentre.com/posts/anatomy-of-a-nixos-config/

## Setup sops.nix
Ensure you can clone sops directory, if not edit `flake.nix:50` to manually place a sops directory.

Create a sops directory in the following manner
```
├── README.md
├── secrets.yaml
└── .sops.yaml
```

### .sops.yaml

This file contains the directives to encrypt and decrypt secrets. We specify users and hosts' keys which can unlock the secrets.
If install was successful, then there should be a private key in `~/.config/sops/age/keys.txt`, which will be used by default to decrypt.

Since we already added that key and hosts key to our password manager, on first install, use one of those and, place it in appropriate location to decrypt.

Or when creating a new host, use the newly generated keys found /etc/ssh/. Ensure that ssh server nix pkg is installed (forgot).

#FIXME: update docs for sops while creating fresh install new host.

```yaml
keys:
  - &hosts:
    - &zenhammer <ssh_pubkey>
    - &zenhammer_age <agekey_from_ssh_pubkey>
  - &users:
    - &madhavpcm <ssh_pubkey>
    - &madhavpcm_age <agekey_from_ssh_pubkey>

creation_rules:
  - path_regex: secrets.yaml$
    key_groups:
    - age:
      - *madhavpcm
      - *zenhammer
      - *zenhammer_age
      - *madhavpcm_age
  - path_regex: tmp.yml$
    key_groups:
    - age:
      - *zenhammer_age
      - *madhavpcm_age
      - *madhavpcm
      - *zenhammer
```

### secrets.yaml
Has data like:

```
keys:
    user: <private_age_key>    
passwords:
    user: <etc_password_hash>
```

## Install
### Setup a host

Use `./hosts/nixos/zenhammer/*` as a template and create your own host directory. `./hosts/nixos/<new_host>`
- `hardware-configurations.nix` is to be generated by you for your host. (`$ nixos-generate-config`)
- Commonly used services can be found in `./hosts/common/`, conveniently segregated into `core` and `opt`.

For example, in your `./hosts/nixos/new_host/default.nix`, use to load all of core and selectively load optional packages/modules.

```nix
  imports = lib.flatten [ # Include the results of the hardware scan.
    ./hardware-configuration.nix

    inputs.stylix.nixosModules.stylix
    (map lib.custom.relativeToRoot [
      # ========== Required Configs ==========
      "hosts/common/core"
      # ========== Optional Configs ==========
      "hosts/common/opt/services/bluetooth.nix" # pipewire and cli controls
      "hosts/common/opt/audio.nix" # pipewire and cli controls
      "hosts/common/opt/gaming.nix" # steam, gamescope, gamemode, and related hardware
      "hosts/common/opt/hyprland.nix" # window manager
      "hosts/common/opt/vpn.nix" # vpn
      "hosts/common/opt/vlc.nix" # media player
      "hosts/common/opt/wayland-tools.nix" # wayland components and pkgs not available in home-manager
      # "hosts/common/opt/tailscale.nix" # wrieguard
      "hosts/common/opt/wireguard.nix" # wrieguard
    ])
  ];
```

Optionally add other configurations which you need to enable at host level.

Install `sudo nixos-rebuild switch --flake .#new_host`

### Setting up Users

#### Privileged/God User
In the current, `god` is used as an alibi for privileged unix user. The `god` user is declared with a custom type declared in a custom module `host-spec`. The properties and configurations for the user are set in `./hosts/common/users/god/default.nix` and is automatically sourced from the `./hosts/common/core` nix module.

#### Optional Users

There is no other user defined for now, but you can add more users by similar fashion in `./hosts/common/users/<new_user>/default.nix` and include this file in your `hosts/nixos/<new_host>/`

### Setup home-manager

Use `./home/madhavpcm` as template to create your user at  `./home/<new_user>`

Just like the hosts module, home-manager also uses core modules and optional modules. Use the existing user as refernece to create your user with customized packages given. You can change the configuration for the user in different ways for different hosts, `home/madhavpcm/<new_host>.nix` would be the users config for `<new_host>`.

Install: `home-manager switch --flake .#new_user@new_host`
